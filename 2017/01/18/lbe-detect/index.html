<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Enjoy Code Life">
    

    <!--Author-->
    
        <meta name="author" content="GoodOak">
    

    <!-- Title -->
    
    <title>LBEå¹³è¡Œç©ºé—´æ£€æµ‹ï¼ˆæ²™ç›’ç¯å¢ƒæ£€æµ‹ï¼‰ | Code | Oak&#39;s hexo</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Content -->
    <section class="article-container">
<!-- Back Home -->
<a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

<!-- Page Header -->
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>LBEå¹³è¡Œç©ºé—´æ£€æµ‹ï¼ˆæ²™ç›’ç¯å¢ƒæ£€æµ‹ï¼‰</h1>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>LBEå¹³è¡Œç©ºé—´çš„åŠŸèƒ½ä¸»è¦æ˜¯ä»¥æ’ä»¶çš„å½¢å¼åŠ è½½ç¬¬ä¸‰æ–¹çš„åº”ç”¨å¹¶è®©å…¶åœ¨è‡ªå·±çš„è¿›ç¨‹ç©ºé—´å†…è¿è¡Œã€‚ä»¥æ»¡è¶³éœ€è¦åœ¨æ‰‹æœºä¸ŠåŒæ—¶è¿è¡Œä¸¤ä¸ªç›¸åŒAppçš„éœ€æ±‚ã€‚LBEçš„è¿™ç§ç±»ä¼¼åœ¨æ²™ç›’ç¯å¢ƒå†…è¿è¡ŒAppçš„æ¨¡å¼ï¼Œç»™Appçš„é£æ§ç³»ç»Ÿå¸¦æ¥äº†ä¸€å®šçš„å½±å“ã€‚</p>
<p>é¦–å…ˆé£æ§ç³»ç»Ÿæ˜¯ä¸ºäº†å”¯ä¸€çš„è¯†åˆ«ä¸€å°è®¾å¤‡ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å°±éœ€è¦è·å–å¤§é‡çš„æ‰‹æœºä¿¡æ¯ä»¥åŠè®¾å¤‡ä¿¡æ¯ã€‚è€Œè¿è¡Œåœ¨æ²™ç›’ç¯å¢ƒå†…ï¼Œä½¿å¾—ç³»ç»Ÿè·å–åˆ°çš„å‚æ•°å˜å¾—ä¸å†å¯ä¿¡ï¼Œç”šè‡³æ— æ³•è·å–ï¼Œä»è€Œå½±å“äº†æ•´ä¸ªè®¾å¤‡æŒ‡çº¹ç³»ç»Ÿçš„æ•°æ®å®Œæ•´æ€§ã€‚</p>
<p>å…¶æ¬¡é£æ§ç³»ç»Ÿä¸»è¦æ˜¯å¸®åŠ©å®¿ä¸»è¯†åˆ«è®¾å¤‡çš„å¼‚å¸¸è¡Œä¸ºã€‚è€Œç›¸åŒè®¾å¤‡è¿è¡Œå¤šä¸ªè´¦å·ï¼Œä¸”æ²™ç›’ç¯å¢ƒçš„å¤šå˜æ€§ç­‰ä¼šäº§ç”Ÿå¤šç§å¼‚å¸¸çš„è¡Œä¸ºï¼Œæ‰€ä»¥è¯†åˆ«æ²™ç›’ç¯å¢ƒå¯¹é£æ§ç³»ç»Ÿæœ‰é‡è¦çš„æ„ä¹‰ã€‚</p>
<p>åŒæ—¶LBEçš„æ²™ç®±ç¯å¢ƒæ— æ³•å®Œå…¨éš”ç¦»å„ä¸ªåº”ç”¨çš„æƒé™ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥ç›´æ¥æ‰§è¡Œsystem(â€œcp ..â€)å‘½ä»¤å°†Appç›®å½•æ‹·è´èµ°ã€‚è¿™ä¹Ÿå¸¦æ¥äº†å¾ˆå¤§çš„å®‰å…¨é—®é¢˜ã€‚</p>
<h3 id="1-LBEå®ç°åŸç†"><a href="#1-LBEå®ç°åŸç†" class="headerlink" title="1. LBEå®ç°åŸç†"></a>1. LBEå®ç°åŸç†</h3><p>(1)Activityçš„å¯åŠ¨ï¼š</p>
<p>LBEçš„å®ç°ç†å¿µä¸»è¦æ˜¯åœ¨è‡ªèº«çš„Appç«¯å®ç°ä¸€ä¸ªä»£ç†æ¡†æ¶ï¼Œä½œä¸ºä¸€ä¸ªä¸­é—´å±‚è´Ÿè´£æ’ä»¶ï¼ˆç¬¬ä¸‰æ–¹Appï¼‰å’Œç³»ç»Ÿçš„äº¤äº’ã€‚å…¶é¦–å…ˆè§£å†³çš„æœ€é‡è¦çš„é—®é¢˜å°±æ˜¯Android Appçš„æ‰€æœ‰Activityéƒ½éœ€è¦åœ¨AndroidManifest.xmlä¸­äº‹å…ˆè¿›è¡Œå£°æ˜ï¼Œè€ŒLBEæ˜¯æ— æ³•çŸ¥é“ç¬¬ä¸‰æ–¹åº”ç”¨ä¸­çš„å…·ä½“Activityåç§°çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLBEä½¿ç”¨äº†ç±»ä¼¼äºâ€å å‘â€œçš„æ¦‚å¿µçš„æ–¹å¼ï¼Œå°±æ˜¯æå‰åœ¨è‡ªèº«çš„AndroidManifest.xmlä¸­å£°æ˜ä¸€ç³»åˆ—ä¸åŒç±»å‹çš„ä»£ç†Activityï¼Œåœ¨ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦å¯åŠ¨Activityæ—¶ï¼ŒLBEå°±ä½œä¸ºä»£ç†å‘ç³»ç»Ÿè¯·æ±‚å¯åŠ¨è‡ªèº«çš„ä»£ç†Activityï¼ŒåŒæ—¶å¾—åˆ°ç³»ç»Ÿå“åº”åï¼ŒLBEå´åœ¨è‡ªèº«çš„è¿›ç¨‹ç©ºé—´å†…å®ç°å¯åŠ¨ç¬¬ä¸‰æ–¹åº”ç”¨ä¸­çš„Activityï¼Œå¹¶å°†å…¶ä¸ä»£ç†Activityå…³è”ä»è€Œç»•è¿‡ç³»ç»Ÿå¯¹Activityå¯åŠ¨çš„é™åˆ¶ã€‚</p>
<img src="http://res.cloudinary.com/dcn1avvzr/image/upload/v1484893235/LBE_detect.png" title="æµç¨‹å›¾">
<p>é€šè¿‡é˜…è¯»Androidæºç å¯ä»¥çŸ¥é“Activityçš„å¯åŠ¨è¯·æ±‚ä¸»è¦é€šè¿‡ IActivityManagerç±»å‹çš„binderå¥æŸ„å’Œsystem_serverè¿›è¡Œé€šä¿¡æ¥å®Œæˆã€‚å½“ç¬¬ä¸‰æ–¹Appè°ƒç”¨startActivityæ—¶ï¼ŒLBEéœ€è¦hookè¿™ä¸ªé€šä¿¡è¿‡ç¨‹å°†ç›®æ ‡targetã€€Activityæ›¿æ¢æˆLBEçš„ä»£ç†Activityã€‚<br>è¿™ä¸ªAppç«¯çš„é€šä¿¡å¥æŸ„æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œå…¶è·å–çš„ä»£ç ä¸º</p>
<figure class="highlight java"><figcaption><span>android æºç </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>LBEä¸»è¦é€šè¿‡æ›¿æ¢è¿™ä¸ªgDefaultæ¥å®ç°äº†Hookã€‚<br>å…¶æ›¿æ¢ä¸­ä¸»è¦ä½¿ç”¨åˆ°äº†Javaçš„åŠ¨æ€ä»£ç†InvocationHandler</p>
<figure class="highlight java"><figcaption><span>android æºç </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">new_binder = Proxy.newProxyInstance(old_binder.getClassLoader,</div><div class="line">                  <span class="keyword">new</span> Class[]&#123;binder.class&#125;,</div><div class="line">                  <span class="keyword">new</span> InvocationHandler(old_binder));</div><div class="line"><span class="comment">//replace</span></div><div class="line">gDefault.set(new_binder);</div><div class="line"></div></pre></td></tr></table></figure>
<p>LBEå°±æ˜¯é€šè¿‡ç”Ÿæˆçš„åŠ¨æ€ä»£ç†æ¥å®ç°æ›¿æ¢target activityçš„æ“ä½œçš„ï¼Œè¿™æ ·å°±å®ç°äº†å‘ç³»ç»Ÿè¯·æ±‚ä»£ç†Activityå¯åŠ¨çš„è¿‡ç¨‹ã€‚ä½†æ˜¯è¿™ä¸ªæ—¶å€™ç¬¬ä¸‰æ–¹Appçš„Activityè¿˜æ²¡æœ‰çœŸæ­£å¯åŠ¨ã€‚ç”±Androidçš„åŸç†å¯çŸ¥åœ¨startActivityæ—¶ï¼ŒAppå‘system_serverä¼ é€’äº†ä¸€ä¸ªcallBackçš„binderå¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿé€šè¿‡æ ¡éªŒå…è®¸Activityå¯åŠ¨æ—¶ï¼ŒcallBackå°±ä¼šè¢«è°ƒç”¨è§¦å‘Appç«¯å®ç°Activityçš„åˆ›å»ºã€‚</p>
<p>LBEè¦å®ç°ç¬¬ä¸‰æ–¹çš„Activityå¯åŠ¨ï¼Œè¿˜éœ€è¦hookã€€Activityçš„åˆ›å»ºè¿‡ç¨‹ï¼Œå°†targetã€€Activityå†æ¢å›ç¬¬ä¸‰æ–¹Appçš„Activityã€‚</p>
<p>æœ€ç»ˆçš„callBackè°ƒç”¨è§¦å‘äº†performLaunchActivityå‡½æ•°çš„æ‰§è¡Œ</p>
<figure class="highlight java"><figcaption><span>android æºç </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="function">ActivityÂ <span class="title">performLaunchActivity</span><span class="params">(</span></span></div><div class="line">    ActivityClientRecordÂ r,Â IntentÂ customIntent)Â &#123;</div><div class="line">Â </div><div class="line">        java.lang.ClassLoaderÂ clÂ =Â r.packageInfo.getClassLoader();</div><div class="line">        activityÂ =Â mInstrumentation.newActivity(</div><div class="line">          cl,Â component.getClassName(),Â r.intent);</div><div class="line">      &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p>LBEä¸»è¦é€šè¿‡hookæ‰äº†mInstrumentationå¯¹åº”çš„å®ç°ï¼Œæ¥è¾¾åˆ°hooké€»è¾‘çš„ã€‚</p>
<p>(2)ç³»ç»Ÿå‚æ•°çš„ä¿®æ”¹</p>
<p>Androidä¸­çš„è®¸å¤šå‚æ•°éƒ½æ˜¯é€šè¿‡è°ƒç”¨äº†Binderå¯¹è±¡å’Œç³»ç»Ÿè¿›ç¨‹é€šä¿¡æ¥è·å–ï¼Œå¦‚android_idå°±æ˜¯é€šè¿‡ContentProvideræœåŠ¡æ¥è·å–çš„ï¼Œä»¥åŠå¸¸ç”¨çš„getDeviceID()åˆ™å¯¹åº”phone_serviceä¸­ä¸€ä¸ªæœåŠ¡è¯·æ±‚ã€‚</p>
<p>å’Œactivity_manager_serviceä¸€æ ·åªè¦æ›¿æ¢äº†æ‰€æœ‰æœåŠ¡çš„binderå¥æŸ„å°±å¯ä»¥æ¥ç®¡ç¬¬ä¸‰æ–¹Appæ‰€æœ‰ä¸ç³»ç»Ÿçš„é€šä¿¡ã€‚å…¶æ›¿æ¢æ–¹å¼ä¸ºå°†ç”Ÿæˆçš„ä»£ç†binderå¥æŸ„æ’å…¥ServiceManager.sCacheå­—å…¸ä¸­ï¼Œè¦†ç›–åŸæœ‰çš„ç³»ç»Ÿå¥æŸ„ã€‚</p>
<p>æŸ¥çœ‹LBEçš„æºç å‘ç°å¯¹äºå¤§éƒ¨åˆ†çš„ç³»ç»Ÿå‡½æ•°è°ƒç”¨ï¼ŒLBEå¹¶éæ˜¯ä¸€ä¸ªé€æ˜çš„ä»£ç†è¿‡ç¨‹ï¼Œè€Œæ˜¯è¿”å›äº†è‡ªå·±é…ç½®å¥½çš„ç»“æœã€‚å¦‚device_idå’Œandroid_idéƒ½æ˜¯LBEè‡ªå·±ç”Ÿæˆçš„ã€‚è€Œé™„è¿‘wifiçƒ­ç‚¹çš„æ‰«æï¼ŒLBEåˆ™ç›´æ¥è¿”å›äº†ç©ºã€‚</p>
<h3 id="2-æ²™ç›’çš„æ£€æµ‹"><a href="#2-æ²™ç›’çš„æ£€æµ‹" class="headerlink" title="2.æ²™ç›’çš„æ£€æµ‹"></a>2.æ²™ç›’çš„æ£€æµ‹</h3><p>(1)Activityå¯åŠ¨è¿‡ç¨‹çš„hookæ£€æµ‹</p>
<p>ç”±å‰é¢çš„ä»‹ç»ï¼ŒLBEä¸»è¦æ›¿æ¢äº†IActivityManageré€šä¿¡æ¥å£çš„gDefaultå˜é‡ï¼Œä»¥åŠandroid.app.ActivityThreadç±»ä¸­çš„mInstrumentationå˜é‡æ¥å®ç°ç¬¬ä¸‰æ–¹Appçš„Activityå¯åŠ¨ã€‚æ‰€ä»¥åªè¦é€šè¿‡åå°„çš„å½¢å¼è·å–ä¸¤ä¸ªé™æ€å˜é‡å°±å¯è·çŸ¥Appæ˜¯å¦è¿è¡Œåœ¨æ²™ç›’ç¯å¢ƒä¹‹ä¸‹ã€‚</p>
<figure class="highlight java"><figcaption><span>android æºç </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ClassÂ classThreadÂ =Â Class.forName(â€œandroid.app.ActivityThreadâ€);</div><div class="line">Â </div><div class="line">MethodÂ methodÂ =Â classThread.getMethod(â€œcurrentActivityThreadâ€);</div><div class="line">Â </div><div class="line">ObjectÂ threadObjectÂ =Â method.invoke(â€œ<span class="keyword">null</span>â€);</div><div class="line">Â </div><div class="line">FiledÂ instrumentFiledÂ =Â threadObject.getFiled(â€œinstrumentâ€);</div><div class="line">Â </div><div class="line">ObjectÂ instrumentÂ =Â instrumentFiled.get(threadObject);</div><div class="line">Â </div><div class="line">StringÂ instrument_class_stringÂ =Â instrument.getClassName();</div><div class="line">Â </div><div class="line">IfÂ (thread_class_stringÂ !=Â system_thread_string)Â &#123;</div><div class="line">    Log(â€œhookedâ€);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>è·å–ä¸¤ä¸ªå˜é‡ä¹‹åï¼Œå¯ä»¥å‘ç°å…¶å·²ç»è¢«æ›¿æ¢æˆäº†LBEä¸­å®šä¹‰çš„ç±»çš„å®ä¾‹äº†ã€‚å¦‚instrumentationä»android.app.Instrumentationå˜ä¸ºäº†com.lbe.doubleagent.client.fã€‚</p>
<p>(2)ç³»ç»ŸæœåŠ¡hookçš„æ£€æµ‹</p>
<p>ç”±äºç¬¬ä¸‰æ–¹APPæ— æ³•ä¸ç³»ç»Ÿç›´æ¥é€šä¿¡ï¼Œä¸­é—´é€šè¿‡äº†LBEä½œä¸ºä»£ç†ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡è·å–ç³»ç»ŸæœåŠ¡é€šä¿¡å¥æŸ„çš„æ–¹å¼æ£€æµ‹hookã€‚<br><figure class="highlight java"><figcaption><span>android æºç </span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">ClassÂ serviceManagerÂ =Â Class.forName(<span class="string">"android.os.ServiceManager"</span>);</div><div class="line">MethodÂ methodÂ =Â serviceManager.getMethod(<span class="string">"getService"</span>,Â String.class);</div><div class="line">ObjectÂ phoneÂ =Â Â method.invoke(serviceManager.newInstance(),Â <span class="string">"phone"</span>);</div><div class="line">IfÂ (phone.classNameÂ !=Â system_phone)Â &#123;</div><div class="line">Log.i(â€œhookedâ€);Â Â </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®é™…è·å–çš„phoneçš„classNameä¸ºï¼š<br>com.lbe.doubleagent.client.hook.BinderProxyã€‚</p>
<p>è€Œç³»ç»Ÿçš„ä¸ºandroid.os.BinderProxyã€‚</p>

 
                <!-- Meta -->
                <div class="post-meta">
                    <hr>
                    <br>
                    <div class="post-tags">
                        
                            

<a href="/tags/Android/">Android</a>


                        
                    </div>
                    <div class="post-date">
                        2017 å¹´ 01 æœˆ 18 æ—¥
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Disqus Comments -->


            </div>
        </div>
    </div>
</article>
</section>

    <!-- Scripts -->
    <!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script type="text/javascript">
	console.log('Hexo-theme-hollow designed by zchen9 ğŸ™‹ Â© 2015-' + (new Date()).getFullYear());
</script>

    <!-- Google Analytics -->
    

</body>

</html>